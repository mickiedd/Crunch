<?xml version="1.0" encoding="utf-8"?>
<!--
  MinionTestTree - Full guard/combat behavior tree for BehaviacTestMinion.

  Based on BT_PatrolGuard (TopDownBehaviacTest), adapted for the Crunch Minion:
    - Uses AttackTarget (GAS BasicAttack) instead of AttackPlayer
    - Uses PatrolToGoal (Crunch goal-actor aware) instead of Patrol
    - Retains full Parallel + SelectorLoop architecture for responsive state switching

  AIState blackboard values (set by UpdateAIState every tick):
    "Combat"       - Player within AttackRange          → stop, face, loop-attack
    "Chase"        - Player in DetectionRadius+GuardRadius → sprint to player
    "Investigate"  - Player lost, heading to last known position
    "ReturnToPost" - Player left GuardRadius, or drifted from guard post
    "Patrol"       - Default; walk patrol loop + scan at each waypoint

  Structure:
    Parallel (ChildFinishPolicy=CHILDFINISH_LOOP)
      [0] DecoratorAlwaysSuccess → UpdateAIState   (state sensor, always running)
      [1] DecoratorLoop(-1) → SelectorLoop          (behaviour selector, loops forever)
            WithPrecondition(AIState==Combat)       → CombatSequence
            WithPrecondition(AIState==Chase)        → ChaseSequence
            WithPrecondition(AIState==Investigate)  → InvestigateSequence
            WithPrecondition(AIState==ReturnToPost) → ReturnToPostSequence
            Sequence (fallthrough)                  → PatrolSequence

  Methods used:
    UpdateAIState, ChasePlayer, AttackTarget, StopMovement, FaceTarget,
    SetWalkSpeed, SetRunSpeed, ReturnToPost, MoveToLastKnownPos,
    LookAround, ClearLastKnownPos, FindPlayer, PatrolToGoal
-->
<behavior name="MinionTestTree" agenttype="BehaviacTestMinion" version="5">

  <node class="Parallel" id="1">
    <property name="Name" value="Root"/>
    <property name="FailurePolicy" value="FailOnOne_SucceedOnAll"/>
    <property name="ChildFinishPolicy" value="CHILDFINISH_LOOP"/>

    <!-- ── CHILD 0: State updater (runs every tick, never blocks) ─────── -->
    <node class="DecoratorAlwaysSuccess" id="2">
      <node class="Action" id="3">
        <property name="Name" value="UpdateAIState"/>
        <property name="Method" value="UpdateAIState"/>
      </node>
    </node>

    <!-- ── CHILD 1: Behaviour selector (loops forever) ────────────────── -->
    <node class="DecoratorLoop" id="4">
      <property name="Count" value="-1"/>

      <node class="SelectorLoop" id="5">
        <property name="Name" value="BehaviourSelector"/>

        <!-- BRANCH 1: COMBAT ─────────────────────────────────────────── -->
        <node class="WithPrecondition" id="6">
          <node class="Condition" id="7">
            <property name="Opl" value="Self.AIState"/>
            <property name="Operator" value="Equal"/>
            <property name="Opr" value="Combat"/>
          </node>
          <node class="Sequence" id="8">
            <property name="Name" value="CombatSequence"/>
            <!-- Stop moving before attacking -->
            <node class="Action" id="9">
              <property name="Name" value="StopMovement"/>
              <property name="Method" value="StopMovement"/>
            </node>
            <!-- Face the target -->
            <node class="Action" id="10">
              <property name="Name" value="FaceTarget"/>
              <property name="Method" value="FaceTarget"/>
            </node>
            <!-- Attack loop: GAS BasicAttack → wait 1.2s → repeat -->
            <node class="DecoratorLoop" id="11">
              <property name="Count" value="-1"/>
              <node class="Sequence" id="12">
                <node class="Action" id="13">
                  <property name="Name" value="AttackTarget"/>
                  <property name="Method" value="AttackTarget"/>
                </node>
                <node class="Wait" id="14">
                  <property name="Time" value="1.2"/>
                </node>
              </node>
            </node>
          </node>
        </node>

        <!-- BRANCH 2: CHASE ──────────────────────────────────────────── -->
        <node class="WithPrecondition" id="15">
          <node class="Condition" id="16">
            <property name="Opl" value="Self.AIState"/>
            <property name="Operator" value="Equal"/>
            <property name="Opr" value="Chase"/>
          </node>
          <node class="Sequence" id="17">
            <property name="Name" value="ChaseSequence"/>
            <node class="Action" id="18">
              <property name="Name" value="SetRunSpeed"/>
              <property name="Method" value="SetRunSpeed"/>
            </node>
            <!-- Sprint loop: chase → yield 6 frames → repeat -->
            <node class="DecoratorLoop" id="19">
              <property name="Count" value="-1"/>
              <node class="Sequence" id="20">
                <node class="Action" id="21">
                  <property name="Name" value="ChasePlayer"/>
                  <property name="Method" value="ChasePlayer"/>
                </node>
                <node class="WaitFrames" id="22">
                  <property name="Count" value="6"/>
                </node>
              </node>
            </node>
          </node>
        </node>

        <!-- BRANCH 3: INVESTIGATE ────────────────────────────────────── -->
        <node class="WithPrecondition" id="23">
          <node class="Condition" id="24">
            <property name="Opl" value="Self.AIState"/>
            <property name="Operator" value="Equal"/>
            <property name="Opr" value="Investigate"/>
          </node>
          <node class="Sequence" id="25">
            <property name="Name" value="InvestigateSequence"/>
            <node class="Action" id="26">
              <property name="Name" value="SetWalkSpeed"/>
              <property name="Method" value="SetWalkSpeed"/>
            </node>
            <!-- Walk to last known position -->
            <node class="DecoratorLoopUntil" id="27">
              <property name="UntilSuccess" value="true"/>
              <node class="Action" id="28">
                <property name="Name" value="MoveToLastKnownPos"/>
                <property name="Method" value="MoveToLastKnownPos"/>
              </node>
            </node>
            <!-- Look around at the spot -->
            <node class="Action" id="29">
              <property name="Name" value="LookAround"/>
              <property name="Method" value="LookAround"/>
            </node>
            <node class="Wait" id="30">
              <property name="Time" value="1.5"/>
            </node>
            <node class="Action" id="31">
              <property name="Name" value="LookAround"/>
              <property name="Method" value="LookAround"/>
            </node>
            <node class="Wait" id="32">
              <property name="Time" value="1.5"/>
            </node>
            <!-- Clear investigation and return to patrol -->
            <node class="Action" id="33">
              <property name="Name" value="ClearLastKnownPos"/>
              <property name="Method" value="ClearLastKnownPos"/>
            </node>
          </node>
        </node>

        <!-- BRANCH 4: RETURN TO POST ─────────────────────────────────── -->
        <node class="WithPrecondition" id="34">
          <node class="Condition" id="35">
            <property name="Opl" value="Self.AIState"/>
            <property name="Operator" value="Equal"/>
            <property name="Opr" value="ReturnToPost"/>
          </node>
          <node class="Sequence" id="36">
            <property name="Name" value="ReturnToPostSequence"/>
            <node class="Action" id="37">
              <property name="Name" value="SetWalkSpeed"/>
              <property name="Method" value="SetWalkSpeed"/>
            </node>
            <node class="DecoratorLoopUntil" id="38">
              <property name="UntilSuccess" value="true"/>
              <node class="Action" id="39">
                <property name="Name" value="ReturnToPost"/>
                <property name="Method" value="ReturnToPost"/>
              </node>
            </node>
          </node>
        </node>

        <!-- BRANCH 5: PATROL (fallthrough) ──────────────────────────── -->
        <node class="Sequence" id="40">
          <property name="Name" value="PatrolSequence"/>
          <node class="Action" id="41">
            <property name="Name" value="SetWalkSpeed"/>
            <property name="Method" value="SetWalkSpeed"/>
          </node>
          <!-- Move to next waypoint (or goal actor if Crunch goal system provides one) -->
          <node class="Action" id="42">
            <property name="Name" value="PatrolToGoal"/>
            <property name="Method" value="PatrolToGoal"/>
          </node>
          <!-- Pause at waypoint before scanning -->
          <node class="Wait" id="43">
            <property name="Time" value="2.0"/>
          </node>
          <!-- Scan at waypoint: look left, wait, look right, wait, check for player -->
          <node class="Sequence" id="44">
            <property name="Name" value="ScanAtWaypoint"/>
            <node class="Action" id="45">
              <property name="Name" value="LookAround"/>
              <property name="Method" value="LookAround"/>
            </node>
            <node class="Wait" id="46">
              <property name="Time" value="1.5"/>
            </node>
            <node class="Action" id="47">
              <property name="Name" value="LookAround"/>
              <property name="Method" value="LookAround"/>
            </node>
            <node class="Wait" id="48">
              <property name="Time" value="1.5"/>
            </node>
            <node class="Action" id="49">
              <property name="Name" value="FindPlayer"/>
              <property name="Method" value="FindPlayer"/>
            </node>
            <!-- AlwaysSuccess so patrol continues even when no player found -->
            <node class="DecoratorAlwaysSuccess" id="50">
              <node class="Noop" id="51"/>
            </node>
          </node>
        </node>

      </node><!-- /SelectorLoop -->
    </node><!-- /DecoratorLoop -->

  </node><!-- /Parallel -->

</behavior>
